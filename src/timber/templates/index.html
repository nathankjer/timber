{% extends 'base.html' %}
{% block title %}Home{% endblock %}
{% block content %}
<div class="container-fluid mt-4" data-sheet-id="{{ sheet_id }}">
  {% if current_user.is_authenticated %}
  <div class="row">
    <div class="col-md-9" id="canvas-pane">
      <svg id="canvas" style="border:1px solid #ccc; width:100%; height:400px;"></svg>
      <div class="mt-2" id="canvas-tools">
        <select id="element-type" class="form-select form-select-sm d-inline w-auto me-2">
          <option value="Joint">Joint</option>
          <option value="Member">Member</option>
          <option value="Cable">Cable</option>
          <option value="Plane">Plane</option>
          <option value="Solid">Solid</option>
          <option value="Load">Load</option>
          <option value="Support">Support</option>
        </select>
        <button id="add-btn" class="btn btn-primary btn-sm me-2">Add Element</button>
        <div class="btn-group btn-group-sm" role="group" aria-label="Views">
          <button type="button" class="btn btn-outline-secondary view-btn active" data-view="+X">+X</button>
          <button type="button" class="btn btn-outline-secondary view-btn" data-view="-X">-X</button>
          <button type="button" class="btn btn-outline-secondary view-btn" data-view="+Y">+Y</button>
          <button type="button" class="btn btn-outline-secondary view-btn" data-view="-Y">-Y</button>
          <button type="button" class="btn btn-outline-secondary view-btn" data-view="+Z">+Z</button>
          <button type="button" class="btn btn-outline-secondary view-btn" data-view="-Z">-Z</button>
        </div>
        <span class="ms-2">View: <span id="current-view">+X</span></span>
      </div>
    </div>
    <div class="col-md-3" id="properties-pane">
      <h2>Properties</h2>
      <div id="props-content" class="mb-3"></div>
      <button id="delete-btn" class="btn btn-danger btn-sm" disabled>Delete</button>
    </div>
  </div>
  {% else %}
  <div class="text-center">
    <p class="lead">Please <a href="{{ url_for('auth.login') }}">log in</a> or <a href="{{ url_for('auth.register') }}">sign up</a> to continue.</p>
  </div>
  {% endif %}
</div>
{% if current_user.is_authenticated %}
<script>
const sheetId = document.querySelector('[data-sheet-id]').dataset.sheetId;
let elements = [];
let selectedId = null;
let dragId = null;
let dragStartX = 0;
let dragStartY = 0;
let dragOrig = null;
let currentView = '+X';
let zoom = 1;
let panX = 0;
let panY = 0;
let panStartX = 0;
let panStartY = 0;
let panOrigX = 0;
let panOrigY = 0;
const globalProps = { g: 9.81, units: 'metric' };

function projectPoint(p) {
  switch (currentView) {
    case '+X':
      return { x: p.y, y: -p.z };
    case '-X':
      return { x: -p.y, y: -p.z };
    case '+Y':
      return { x: p.x, y: -p.z };
    case '-Y':
      return { x: -p.x, y: -p.z };
    case '+Z':
      return { x: p.x, y: -p.y };
    case '-Z':
      return { x: -p.x, y: -p.y };
  }
}

function unprojectDelta(dx, dy) {
  switch (currentView) {
    case '+X':
      return { y: dx, z: -dy };
    case '-X':
      return { y: -dx, z: -dy };
    case '+Y':
      return { x: dx, z: -dy };
    case '-Y':
      return { x: -dx, z: -dy };
    case '+Z':
      return { x: dx, y: -dy };
    case '-Z':
      return { x: -dx, y: -dy };
  }
}
const SNAP_PIXELS = 10;

function screenCoords(p) {
  const svg = document.getElementById('canvas');
  const rect = svg.getBoundingClientRect();
  const cx = rect.width / 2 + panX;
  const cy = rect.height / 2 + panY;
  const proj = projectPoint(p);
  return { x: cx + (proj.x || 0) * zoom, y: cy + (proj.y || 0) * zoom };
}

function distanceScreen(a, b) {
  return Math.hypot(a.x - b.x, a.y - b.y);
}

function nearestPointOnLine(p, a, b) {
  const ab = { x: b.x - a.x, y: b.y - a.y, z: b.z - a.z };
  const ap = { x: p.x - a.x, y: p.y - a.y, z: p.z - a.z };
  const ab2 = ab.x * ab.x + ab.y * ab.y + ab.z * ab.z;
  if (ab2 === 0) return { ...a };
  let t = (ap.x * ab.x + ap.y * ab.y + ap.z * ab.z) / ab2;
  t = Math.max(0, Math.min(1, t));
  return { x: a.x + ab.x * t, y: a.y + ab.y * t, z: a.z + ab.z * t };
}

function getSnapPoints(ignoreId) {
  const pts = [];
  elements.forEach(e => {
    if (e.id === ignoreId) return;
    if (e.type === 'Joint') pts.push({ x: e.x, y: e.y, z: e.z, kind: 'Joint' });
    if (e.type === 'Support' || e.type === 'Load') pts.push({ x: e.x, y: e.y, z: e.z, kind: e.type });
    if (e.type === 'Member' || e.type === 'Cable') {
      pts.push({ x: e.x, y: e.y, z: e.z, kind: 'End' });
      pts.push({ x: e.x2 ?? e.x, y: e.y2 ?? e.y, z: e.z2 ?? e.z, kind: 'End' });
    }
    if (e.type === 'Plane') {
      const s = 20;
      [-s, s].forEach(dx => [-s, s].forEach(dy => pts.push({ x: e.x + dx, y: e.y + dy, z: e.z, kind: 'PlaneCorner' })));
    }
    if (e.type === 'Solid') {
      const s = 15;
      [-s, s].forEach(dx => [-s, s].forEach(dy => [-s, s].forEach(dz => pts.push({ x: e.x + dx, y: e.y + dy, z: e.z + dz, kind: 'SolidCorner' }))));
      [-s, s].forEach(dx => pts.push({ x: e.x + dx, y: e.y, z: e.z, kind: 'FaceCenter' }));
      [-s, s].forEach(dy => pts.push({ x: e.x, y: e.y + dy, z: e.z, kind: 'FaceCenter' }));
      [-s, s].forEach(dz => pts.push({ x: e.x, y: e.y, z: e.z + dz, kind: 'FaceCenter' }));
    }
  });
  return pts;
}

function getSnapLines(ignoreId) {
  const lines = [];
  elements.forEach(e => {
    if (e.id === ignoreId) return;
    if (e.type === 'Member' || e.type === 'Cable') {
      lines.push({ p1: { x: e.x, y: e.y, z: e.z }, p2: { x: e.x2 ?? e.x, y: e.y2 ?? e.y, z: e.z2 ?? e.z } });
    }
  });
  return lines;
}

function ensureJointAt(x, y, z) {
  const tol = 1e-6;
  if (elements.some(e => e.type === 'Joint' && Math.abs(e.x - x) < tol && Math.abs(e.y - y) < tol && Math.abs(e.z - z) < tol)) return;
  elements.push({ id: Date.now() + Math.random(), type: 'Joint', x, y, z });
}

function applySnapping(el) {
  const pts = getSnapPoints(el.id);
  const lines = getSnapLines(el.id);

  function snapObj(obj, createJoint) {
    const sc = screenCoords(obj);
    let best = null;
    let bestKind = null;
    let bestDist = SNAP_PIXELS;
    pts.forEach(pt => {
      const d = distanceScreen(sc, screenCoords(pt));
      if (d < bestDist) { best = pt; bestDist = d; bestKind = pt.kind; }
    });
    lines.forEach(line => {
      const near = nearestPointOnLine(obj, line.p1, line.p2);
      const d = distanceScreen(sc, screenCoords(near));
      if (d < bestDist) { best = near; bestDist = d; bestKind = 'Line'; }
    });
    if (best) {
      obj.x = best.x; obj.y = best.y; obj.z = best.z;
      if (createJoint && bestKind === 'End') ensureJointAt(best.x, best.y, best.z);
    }
  }

  if (el.type === 'Joint' || el.type === 'Support' || el.type === 'Load') {
    snapObj(el, false);
  } else if (el.type === 'Member' || el.type === 'Cable') {
    const p1 = { x: el.x, y: el.y, z: el.z };
    const p2 = { x: el.x2 ?? el.x, y: el.y2 ?? el.y, z: el.z2 ?? el.z };
    snapObj(p1, true);
    snapObj(p2, true);
    el.x = p1.x; el.y = p1.y; el.z = p1.z;
    el.x2 = p2.x; el.y2 = p2.y; el.z2 = p2.z;
  } else {
    snapObj(el, false);
  }
}

function addNumberInput(container, label, prop, el) {
  const div = document.createElement('div');
  div.className = 'mb-2';
  div.innerHTML = `<label class='form-label'>${label}</label><input id='prop-${prop}' class='form-control form-control-sm' type='number' value='${el[prop] ?? 0}'>`;
  const input = div.querySelector('input');
  input.addEventListener('input', ev => {
    const v = parseFloat(ev.target.value);
    el[prop] = Number.isFinite(v) ? v : 0;
    render();
    saveState();
  });
  container.appendChild(div);
}

function renderProperties() {
  const pane = document.getElementById('props-content');
  pane.innerHTML = '';
  if (selectedId !== null) {
    const el = elements.find(e => e.id === selectedId);
    if (el) {
      const form = document.createElement('div');
      form.innerHTML = `<div class="mb-2">Type: <strong>${el.type}</strong></div>`;
      ['x', 'y', 'z'].forEach(p => addNumberInput(form, p, p, el));
      if (el.type === 'Member' || el.type === 'Cable') {
        ['x2', 'y2', 'z2'].forEach(p => addNumberInput(form, p, p, el));
      }
      pane.appendChild(form);
      document.getElementById('delete-btn').disabled = false;
    }
  } else {
    document.getElementById('delete-btn').disabled = true;
  }

  const globalDiv = document.createElement('div');
  globalDiv.innerHTML = `<hr><h6>Global</h6>
    <div class='mb-2'><label class='form-label'>g</label><input id='global-g' class='form-control form-control-sm' type='number' value='${globalProps.g}' readonly></div>
    <div class='mb-2'><label class='form-label'>Units</label><select id='global-units' class='form-select form-select-sm'>
      <option value='metric'>Metric</option><option value='imperial'>Imperial</option></select></div>`;
  pane.appendChild(globalDiv);
  const sel = globalDiv.querySelector('#global-units');
  sel.value = globalProps.units;
  sel.addEventListener('change', ev => {
    globalProps.units = ev.target.value;
    globalProps.g = globalProps.units === 'metric' ? 9.81 : 32.19;
    renderProperties();
  });
}

function render() {
  const svg = document.getElementById('canvas');
  svg.innerHTML = '';
  const rect = svg.getBoundingClientRect();
  const cx = rect.width / 2 + panX;
  const cy = rect.height / 2 + panY;
  document.getElementById('current-view').textContent = currentView;

  elements.forEach(el => {
    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.dataset.id = el.id;
    g.style.cursor = 'move';
    g.addEventListener('mousedown', startDrag);
    g.addEventListener('click', e => { e.stopPropagation(); selectElement(el.id); });

    let shape;
    if (el.type === 'Member' || el.type === 'Cable') {
      const p1 = projectPoint({ x: el.x, y: el.y, z: el.z });
      const p2 = projectPoint({ x: el.x2 ?? el.x, y: el.y2 ?? el.y, z: el.z2 ?? el.z });
      shape = document.createElementNS('http://www.w3.org/2000/svg', 'line');
      shape.setAttribute('x1', cx + (p1.x || 0) * zoom);
      shape.setAttribute('y1', cy + (p1.y || 0) * zoom);
      shape.setAttribute('x2', cx + (p2.x || 0) * zoom);
      shape.setAttribute('y2', cy + (p2.y || 0) * zoom);
      shape.setAttribute('stroke', 'blue');
      shape.setAttribute('stroke-width', 2);
      if (el.type === 'Cable') shape.setAttribute('stroke-dasharray', '4 2');
    } else {
      const p = projectPoint({ x: el.x, y: el.y, z: el.z });
      const sx = cx + (p.x || 0) * zoom;
      const sy = cy + (p.y || 0) * zoom;
      if (el.type === 'Joint') {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        shape.setAttribute('cx', sx);
        shape.setAttribute('cy', sy);
        shape.setAttribute('r', 4);
        shape.setAttribute('fill', 'blue');
      } else if (el.type === 'Plane') {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        shape.setAttribute('x', sx - 20 * zoom);
        shape.setAttribute('y', sy - 20 * zoom);
        shape.setAttribute('width', 40 * zoom);
        shape.setAttribute('height', 40 * zoom);
        shape.setAttribute('fill', 'rgba(0,0,255,0.2)');
        shape.setAttribute('stroke', 'blue');
      } else if (el.type === 'Solid') {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        shape.setAttribute('x', sx - 15 * zoom);
        shape.setAttribute('y', sy - 15 * zoom);
        shape.setAttribute('width', 30 * zoom);
        shape.setAttribute('height', 30 * zoom);
        shape.setAttribute('fill', 'rgba(0,0,255,0.4)');
        shape.setAttribute('stroke', 'blue');
      } else if (el.type === 'Load') {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        shape.setAttribute('x1', sx);
        shape.setAttribute('y1', sy - 20 * zoom);
        shape.setAttribute('x2', sx);
        shape.setAttribute('y2', sy);
        shape.setAttribute('stroke', 'red');
        shape.setAttribute('stroke-width', 2);
        const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        arrow.setAttribute('points', `${sx - 4 * zoom},${sy - 20 * zoom} ${sx + 4 * zoom},${sy - 20 * zoom} ${sx},${sy - 25 * zoom}`);
        arrow.setAttribute('fill', 'red');
        g.appendChild(arrow);
      } else if (el.type === 'Support') {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
        shape.setAttribute('points', `${sx - 6 * zoom},${sy} ${sx + 6 * zoom},${sy} ${sx},${sy - 10 * zoom}`);
        shape.setAttribute('fill', 'green');
      } else {
        shape = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        shape.setAttribute('cx', sx);
        shape.setAttribute('cy', sy);
        shape.setAttribute('r', 4);
        shape.setAttribute('fill', 'blue');
      }
    }
    if (shape) g.appendChild(shape);
    if (el.id === selectedId) g.setAttribute('stroke', 'orange');
    svg.appendChild(g);
  });

  renderProperties();
}

function addElement(type) {
  const id = Date.now();
  const center = unprojectDelta(-panX / zoom, -panY / zoom);
  const base = {
    id,
    type,
    x: center.x || 0,
    y: center.y || 0,
    z: center.z || 0,
  };
  if (type === 'Member' || type === 'Cable') {
    const dir = unprojectDelta(40, 0);
    Object.assign(base, {
      x2: base.x + (dir.x || 0),
      y2: base.y + (dir.y || 0),
      z2: base.z + (dir.z || 0),
    });
  }
  elements.push(base);
  applySnapping(base);
  saveState();
  render();
}

function deleteElement() {
  if (selectedId === null) return;
  elements = elements.filter(e => e.id !== selectedId);
  selectedId = null;
  saveState();
  render();
}

function startDrag(ev) {
  const id = parseInt(ev.target.parentNode.dataset.id || ev.target.dataset.id, 10);
  const el = elements.find(e => e.id === id);
  if (!el) return;
  dragId = id;
  selectedId = id;
  dragStartX = ev.clientX;
  dragStartY = ev.clientY;
  dragOrig = JSON.parse(JSON.stringify(el));
  document.addEventListener('mousemove', onDrag);
  document.addEventListener('mouseup', endDrag);
  ev.stopPropagation();
}

function onDrag(ev) {
  if (dragId === null) return;
  const el = elements.find(e => e.id === dragId);
  if (!el) return;
  const dx = (ev.clientX - dragStartX) / zoom;
  const dy = (ev.clientY - dragStartY) / zoom;
  const delta = unprojectDelta(dx, dy);
  if (el.type === 'Member' || el.type === 'Cable') {
    ['x', 'y', 'z', 'x2', 'y2', 'z2'].forEach(k => {
      el[k] = dragOrig[k] + (delta[k.slice(-1)] ?? delta[k] ?? 0);
    });
  } else {
    ['x', 'y', 'z'].forEach(k => {
      if (delta[k] !== undefined) el[k] = dragOrig[k] + delta[k];
    });
  }
  render();
}

function endDrag() {
  if (dragId === null) return;
  document.removeEventListener('mousemove', onDrag);
  document.removeEventListener('mouseup', endDrag);
  const el = elements.find(e => e.id === dragId);
  if (el) applySnapping(el);
  dragId = null;
  saveState();
  render();
}

function startPan(ev) {
  panStartX = ev.clientX;
  panStartY = ev.clientY;
  panOrigX = panX;
  panOrigY = panY;
  document.addEventListener('mousemove', onPan);
  document.addEventListener('mouseup', endPan);
}

function onPan(ev) {
  panX = panOrigX + (ev.clientX - panStartX);
  panY = panOrigY + (ev.clientY - panStartY);
  render();
}

function endPan() {
  document.removeEventListener('mousemove', onPan);
  document.removeEventListener('mouseup', endPan);
}

async function saveState() {
  await fetch('/sheet/action', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sheet_id: sheetId, elements })
  });
}

async function loadState() {
  const resp = await fetch(`/sheet/${sheetId}`);
  if (resp.ok) {
    const data = await resp.json();
    elements = (data.elements || []).map(e => {
      const obj = {
        id: e.id,
        type: e.type || 'Joint',
        x: e.x ?? 0,
        y: e.y ?? 0,
        z: e.z ?? 0,
      };
      if (obj.type === 'Member' || obj.type === 'Cable') {
        obj.x2 = e.x2 ?? obj.x;
        obj.y2 = e.y2 ?? obj.y;
        obj.z2 = e.z2 ?? obj.z;
      }
      return obj;
    });
    render();
  }
}

document.getElementById('add-btn').addEventListener('click', () => {
  const type = document.getElementById('element-type').value;
  addElement(type);
});
document.getElementById('delete-btn').addEventListener('click', deleteElement);
document.getElementById('canvas').addEventListener('click', () => {
  selectedId = null;
  render();
});
document.getElementById('canvas').addEventListener('mousedown', startPan);
document.getElementById('canvas').addEventListener('wheel', ev => {
  ev.preventDefault();
  zoom *= ev.deltaY < 0 ? 1.1 : 0.9;
  render();
});

document.querySelectorAll('.view-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    currentView = btn.dataset.view;
    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    render();
  });
});

loadState();
</script>
{% endif %}
{% endblock %}
