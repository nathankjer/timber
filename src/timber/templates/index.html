{% extends 'base.html' %}
{% block title %}Home{% endblock %}
{% block content %}
<div class="container-fluid mt-4" data-sheet-id="{{ sheet_id }}">
  {% if current_user.is_authenticated %}
  <div class="row">
    <div class="col-md-3" id="properties-pane">
      <h2>Properties</h2>
      <div id="props-content" class="mb-3"></div>
      <button id="delete-btn" class="btn btn-danger btn-sm" disabled>Delete</button>
    </div>
    <div class="col-md-9" id="canvas-pane">
      <div class="mb-2">
        <button id="add-btn" class="btn btn-primary btn-sm">Add Element</button>
      </div>
      <div id="canvas" style="position:relative; border:1px solid #ccc; height:400px;"></div>
    </div>
  </div>
  {% else %}
  <div class="text-center">
    <p class="lead">Please <a href="{{ url_for('auth.login') }}">log in</a> or <a href="{{ url_for('auth.register') }}">sign up</a> to continue.</p>
  </div>
  {% endif %}
</div>
{% if current_user.is_authenticated %}
<script>
const sheetId = document.querySelector('[data-sheet-id]').dataset.sheetId;
let elements = [];
let selectedId = null;

function render() {
  const canvas = document.getElementById('canvas');
  canvas.innerHTML = '';
  elements.forEach(el => {
    const div = document.createElement('div');
    div.className = 'element border rounded-circle bg-primary';
    div.style.position = 'absolute';
    div.style.width = '10px';
    div.style.height = '10px';
    div.style.left = `${el.x}px`;
    div.style.top = `${el.y}px`;
    div.dataset.id = el.id;
    if (el.id === selectedId) div.classList.add('border-warning');
    div.addEventListener('click', e => {
      e.stopPropagation();
      selectElement(el.id);
    });
    canvas.appendChild(div);
  });
}

function selectElement(id) {
  selectedId = id;
  const el = elements.find(e => e.id === id);
  const pane = document.getElementById('props-content');
  pane.innerHTML = '';
  if (!el) return;
  const form = document.createElement('div');
  form.innerHTML = `<div class="mb-2"><label class='form-label'>x</label><input id='prop-x' class='form-control form-control-sm' type='number' value='${el.x}'></div>
    <div class="mb-2"><label class='form-label'>y</label><input id='prop-y' class='form-control form-control-sm' type='number' value='${el.y}'></div>`;
  pane.appendChild(form);
  document.getElementById('delete-btn').disabled = false;
  document.getElementById('prop-x').addEventListener('input', ev => {
    el.x = parseFloat(ev.target.value);
    render();
    saveState();
  });
  document.getElementById('prop-y').addEventListener('input', ev => {
    el.y = parseFloat(ev.target.value);
    render();
    saveState();
  });
  render();
}

function addElement() {
  const id = Date.now();
  elements.push({id, x: 50, y: 50});
  saveState();
  render();
}

function deleteElement() {
  if (selectedId === null) return;
  elements = elements.filter(e => e.id !== selectedId);
  selectedId = null;
  document.getElementById('props-content').innerHTML = '';
  document.getElementById('delete-btn').disabled = true;
  saveState();
  render();
}

async function saveState() {
  await fetch('/sheet/action', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({sheet_id: sheetId, elements})
  });
}

async function loadState() {
  const resp = await fetch(`/sheet/${sheetId}`);
  if (resp.ok) {
    const data = await resp.json();
    elements = data.elements || [];
    render();
  }
}

document.getElementById('add-btn').addEventListener('click', addElement);
document.getElementById('delete-btn').addEventListener('click', deleteElement);
document.getElementById('canvas').addEventListener('click', () => {
  selectedId = null;
  document.getElementById('props-content').innerHTML = '';
  document.getElementById('delete-btn').disabled = true;
  render();
});

loadState();
</script>
{% endif %}
{% endblock %}
